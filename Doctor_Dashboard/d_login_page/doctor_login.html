<!doctype html>
<html lang="bn">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Doctor Login — Doctor Master</title>
  <style>
    :root {
      --bg: #eef2f7;
      --card: #fff;
      --accent: #2563eb;
      --accent-2: #1e4fcc;
      --muted: #6b7280;
      --radius: 14px;
      --shadow: 0 10px 36px rgba(0, 0, 0, 0.10)
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #dce6ff, #eef2f7);
      font-family: Inter, system-ui;
      padding: 20px
    }

    .wrap {
      width: 100%;
      max-width: 380px
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
      animation: fadeUp .36s ease
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(12px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .brand {
      font-weight: 700;
      color: var(--accent);
      font-size: 22px;
      text-align: center;
      margin-bottom: 8px
    }

    h2 {
      font-size: 18px;
      text-align: center;
      margin-bottom: 6px
    }

    .muted {
      text-align: center;
      color: var(--muted);
      margin-bottom: 18px
    }

    label {
      display: block;
      margin: 10px 0 6px;
      color: #111
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #d3d9e4;
      background: #fbfdff;
      font-size: 14px
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12)
    }

    .field {
      position: relative
    }

    .showpw {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: 0;
      color: var(--muted);
      cursor: pointer
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      background: var(--accent);
      color: #fff;
      border: 0;
      font-weight: 600;
      margin-top: 16px;
      cursor: pointer
    }

    .btn:hover {
      background: var(--accent-2)
    }

    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px
    }

    .link {
      background: none;
      border: 0;
      color: var(--accent);
      cursor: pointer;
      font-size: 14px
    }

    .msg {
      margin-top: 14px;
      padding: 12px;
      border-radius: 10px;
      display: none;
      text-align: center
    }

    .error {
      background: #fff1f2;
      color: #9f1239
    }

    .success {
      background: #ecfdf5;
      color: #065f46
    }

    .small {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-top: 14px
    }

    .switch {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 12px
    }

    .switch button {
      background: none;
      border: 1px solid transparent;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    .switch .active {
      border-color: rgba(37, 99, 235, 0.16);
      background: rgba(37, 99, 235, 0.06)
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="container">
      <div class="brand">Doctor Master</div>

      <!-- Switch -->
      <div class="switch" role="tablist" aria-label="Login or Change password">
        <button id="tabLogin" class="active" role="tab" aria-selected="true">Login</button>
        <button id="tabChange" role="tab" aria-selected="false">Change password</button>
      </div>

      <!-- LOGIN FORM -->
      <form id="loginForm" autocomplete="on">
        <h2>Doctor Login</h2>

        <label for="userid">User ID</label>
        <div class="field">
          <input id="userid" name="userid" type="text" placeholder="DR-12345" required />
        </div>

        <label for="password">Password</label>
        <div class="field">
          <input id="password" name="password" type="password" placeholder="Enter password" required minlength="6" />
          <button type="button" class="showpw" data-target="password">Show</button>
        </div>

        <div class="actions">
          <label style="display:flex;align-items:center;gap:8px"><input id="remember" type="checkbox" /> <span
              style="font-size:13px">Remember me</span></label>
          <button type="button" class="link" id="openChange">Forgot / Change</button>
        </div>

        <button class="btn" type="submit">Sign in</button>

        <div id="loginMsg" class="msg" role="status" aria-live="polite"></div>
      </form>

      <!-- CHANGE PASSWORD FORM -->
      <form id="changeForm" style="display:none;margin-top:6px" autocomplete="on">
        <h2>Change Password</h2>


        <label for="c_userid">User ID</label>
        <div class="field">
          <input id="c_userid" name="c_userid" type="text" placeholder="DR-12345" required />
        </div>

        <label for="oldpwd">Old Password</label>
        <div class="field">
          <input id="oldpwd" name="oldpwd" type="password" placeholder="Current password" required />
          <button type="button" class="showpw" data-target="oldpwd">Show</button>
        </div>

        <label for="newpwd">New Password</label>
        <div class="field">
          <input id="newpwd" name="newpwd" type="password" placeholder="Minimum 6 characters" required minlength="6" />
          <button type="button" class="showpw" data-target="newpwd">Show</button>
        </div>

        <label for="confpwd">Confirm New Password</label>
        <div class="field">
          <input id="confpwd" name="confpwd" type="password" placeholder="Repeat new password" required minlength="6" />
          <button type="button" class="showpw" data-target="confpwd">Show</button>
        </div>

        <div style="display:flex;gap:8px">
          <button class="btn" type="submit">Update password</button>
          <button type="button" class="link" id="backToLogin">Back</button>
        </div>

        <div id="changeMsg" class="msg" role="status" aria-live="polite"></div>
      </form>


    </div>
  </div>

  <script>
    // Element refs
    const tabLogin = document.getElementById('tabLogin');
    const tabChange = document.getElementById('tabChange');
    const loginForm = document.getElementById('loginForm');
    const changeForm = document.getElementById('changeForm');
    const openChange = document.getElementById('openChange');
    const backToLogin = document.getElementById('backToLogin');

    function showTab(tab) {
      if (tab === 'login') {
        loginForm.style.display = 'block'; changeForm.style.display = 'none';
        tabLogin.classList.add('active'); tabChange.classList.remove('active');
        tabLogin.setAttribute('aria-selected', 'true'); tabChange.setAttribute('aria-selected', 'false');
      } else {
        loginForm.style.display = 'none'; changeForm.style.display = 'block';
        tabLogin.classList.remove('active'); tabChange.classList.add('active');
        tabLogin.setAttribute('aria-selected', 'false'); tabChange.setAttribute('aria-selected', 'true');
      }
    }

    tabLogin.addEventListener('click', () => showTab('login'));
    tabChange.addEventListener('click', () => showTab('change'));
    openChange.addEventListener('click', () => showTab('change'));
    backToLogin.addEventListener('click', () => showTab('login'));

    // show/hide password buttons
    document.querySelectorAll('.showpw').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        if (target.type === 'password') { target.type = 'text'; btn.innerText = 'Hide'; }
        else { target.type = 'password'; btn.innerText = 'Show'; }
      });
    });

    // LOGIN submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('loginMsg'); msg.style.display = 'none';
      const userid = document.getElementById('userid').value.trim();
      const password = document.getElementById('password').value;
      if (!userid || !password) { msg.className = 'msg error'; msg.innerText = 'Provide user id and password'; msg.style.display = 'block'; return; }

      // 1. Check Local Storage
      try {
        const localUsers = JSON.parse(localStorage.getItem('rm_users_v1') || '[]');
        const found = localUsers.find(u => u.username === userid && u.password === password);
        if (found) {
          if (found.status === 0) { msg.className = 'msg error'; msg.innerText = 'Account is inactive'; msg.style.display = 'block'; return; }
          const docInfo = { id: found._id, name: found.fullname || found.username, username: found.username, category: found.category };
          sessionStorage.setItem('doctor_token', 'local_token_' + Date.now());
          sessionStorage.setItem('doctor_info', JSON.stringify(docInfo));
          msg.className = 'msg success'; msg.innerText = 'Login successful (Local) — redirecting...'; msg.style.display = 'block';
          setTimeout(() => { location.href = '/doctor_dashboard'; }, 700);
          return;
        }
      } catch (err) { console.error('Local login check failed', err); }

      // 2. Fallback to Server API
      try {
        const res = await fetch('/api/doctors/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userid, password }) });
        const json = await res.json();
        if (res.ok) { if (json.token) sessionStorage.setItem('doctor_token', json.token); if (json.doctor) sessionStorage.setItem('doctor_info', JSON.stringify(json.doctor)); msg.className = 'msg success'; msg.innerText = 'Login successful — redirecting...'; msg.style.display = 'block'; setTimeout(() => location.href = '/doctor_dashboard', 700); }
        else { msg.className = 'msg error'; msg.innerText = json.error || json.message || 'Invalid user id or password'; msg.style.display = 'block'; }
      } catch (err) { msg.className = 'msg error'; msg.innerText = 'Network error: ' + err.message; msg.style.display = 'block'; }
    });

    // CHANGE PASSWORD submit
    changeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('changeMsg'); msg.style.display = 'none';
      const userid = document.getElementById('c_userid').value.trim();
      const oldpwd = document.getElementById('oldpwd').value;
      const newpwd = document.getElementById('newpwd').value;
      const confpwd = document.getElementById('confpwd').value;

      if (!userid) { msg.className = 'msg error'; msg.innerText = 'User ID is required'; msg.style.display = 'block'; return; }
      if (newpwd.length < 6) { msg.className = 'msg error'; msg.innerText = 'New password must be at least 6 characters'; msg.style.display = 'block'; return; }
      if (newpwd !== confpwd) { msg.className = 'msg error'; msg.innerText = 'New password and confirm password do not match'; msg.style.display = 'block'; return; }
      if (newpwd === oldpwd) { msg.className = 'msg error'; msg.innerText = 'New password must be different from old password'; msg.style.display = 'block'; return; }

      try {
        const res = await fetch('/api/doctors/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userid, old_password: oldpwd, new_password: newpwd }) });
        const json = await res.json();
        if (res.ok) { msg.className = 'msg success'; msg.innerText = json.message || 'Password updated successfully. Redirecting to login...'; msg.style.display = 'block'; setTimeout(() => showTab('login'), 900); }
        else { msg.className = 'msg error'; msg.innerText = json.error || json.message || 'Could not update password'; msg.style.display = 'block'; }
      } catch (err) { msg.className = 'msg error'; msg.innerText = 'Network error: ' + err.message; msg.style.display = 'block'; }
    });

    // Initialize state
    showTab('login');
  </script>
</body>

</html>